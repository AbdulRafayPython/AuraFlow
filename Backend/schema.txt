-- =====================================
-- üåê AuraFlow v4.0 - UNIFIED DATABASE SCHEMA
-- Backend: Flask | Database: MySQL
-- Complete & Production Ready
-- =====================================

CREATE DATABASE IF NOT EXISTS auraflow;
USE auraflow;

-- =====================================
-- 1Ô∏è‚É£ USERS & AUTHENTICATION
-- =====================================

CREATE TABLE `users` (

  `id` int NOT NULL AUTO_INCREMENT,

  `email` varchar(255) DEFAULT NULL,

  `display_name` varchar(255) DEFAULT NULL,

  `username` varchar(255) NOT NULL,

  `password` varchar(255) NOT NULL,

  `token` varchar(1500) DEFAULT NULL,

  `bio` text,

  `avatar_url` varchar(500) DEFAULT NULL,

  `status` enum('online','idle','dnd','offline') DEFAULT 'offline',

  `custom_status` varchar(255) DEFAULT NULL,

  `last_seen` timestamp NULL DEFAULT NULL,

  `is_first_login` tinyint(1) NOT NULL DEFAULT '1',

  `password_reset_token` varchar(500) DEFAULT NULL,

  `password_reset_expires` timestamp NULL DEFAULT NULL,

  `otp_verified` tinyint(1) DEFAULT '0',

  `otp_verified_at` timestamp NULL DEFAULT NULL,

  `created_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP,

  `updated_at` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),

  UNIQUE KEY `username` (`username`),

  UNIQUE KEY `email` (`email`),

  KEY `idx_user_email` (`email`),

  KEY `idx_username` (`username`),

  KEY `idx_password_reset_token` (`password_reset_token`)

) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;


-- =====================================
-- 2Ô∏è‚É£ ROLES & PERMISSIONS
-- =====================================

CREATE TABLE roles (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT
);

CREATE TABLE user_roles (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  role_id INT,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  UNIQUE KEY unique_user_role (user_id, role_id)
);

-- =====================================
-- 3Ô∏è‚É£ COMMUNITIES (Servers/Groups)
-- =====================================

CREATE TABLE communities (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon CHAR(2) DEFAULT 'AF',
  color VARCHAR(7) DEFAULT '#8B5CF6',
  logo_url VARCHAR(500),
  banner_url VARCHAR(500),
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  INDEX idx_community_name (name)
);

CREATE TABLE community_members (
  id INT AUTO_INCREMENT PRIMARY KEY,
  community_id INT,
  user_id INT,
  role ENUM('owner','admin','member') DEFAULT 'member',
  violation_count INT DEFAULT 0,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_member (community_id, user_id)
);

-- Blocked users per community
CREATE TABLE blocked_users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  community_id INT NOT NULL,
  user_id INT NOT NULL,
  blocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_blocked_user (community_id, user_id),
  INDEX idx_blocked_user (user_id)
);

-- =====================================
-- üîê OTP CODES (For Email Verification & Password Reset)
-- =====================================
-- Used for: Email verification on signup, Password reset OTP verification
-- Fields: email (recipient), otp_hash (hashed OTP code), expires_at (TTL for OTP validity)
CREATE TABLE IF NOT EXISTS otp_codes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(255) NOT NULL,
  otp_hash VARCHAR(255) NOT NULL,
  purpose ENUM('email_verification', 'password_reset') DEFAULT 'password_reset',
  is_used TINYINT(1) DEFAULT 0,
  used_at TIMESTAMP NULL DEFAULT NULL,
  expires_at DATETIME NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX (email),
  INDEX (expires_at),
  INDEX (purpose)
);


-- =====================================
-- 4Ô∏è‚É£ CHANNELS
-- =====================================

CREATE TABLE channels (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  type ENUM('text','voice','private') DEFAULT 'text',
  community_id INT NULL,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  INDEX idx_channel_name (name),
  INDEX idx_community_channels (community_id)
);

CREATE TABLE channel_members (
  id INT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT,
  user_id INT,
  role ENUM('member','admin','moderator') DEFAULT 'member',
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_channel_member (channel_id, user_id)
);

-- =====================================
-- 5Ô∏è‚É£ MESSAGES
-- =====================================

CREATE TABLE messages (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT,
  sender_id INT,
  content TEXT,
  message_type ENUM('text','image','file','system','ai') DEFAULT 'text',
  reply_to BIGINT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  edited_at TIMESTAMP NULL,
  moderation_flagged BOOLEAN DEFAULT FALSE,
  moderation_score FLOAT DEFAULT 0.0,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (reply_to) REFERENCES messages(id) ON DELETE SET NULL,
  INDEX idx_channel_id (channel_id),
  INDEX idx_sender_id (sender_id),
  INDEX idx_messages_time (created_at DESC),
  FULLTEXT INDEX ft_messages (content)
);

CREATE TABLE message_reactions (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  message_id BIGINT,
  user_id INT,
  emoji VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_reaction (message_id, user_id, emoji)
);

CREATE TABLE pinned_messages (
  id INT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT,
  message_id BIGINT,
  pinned_by INT,
  pinned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  FOREIGN KEY (pinned_by) REFERENCES users(id) ON DELETE CASCADE
);

-- =====================================
-- 6Ô∏è‚É£ DIRECT MESSAGES (Private Chats)
-- =====================================

CREATE TABLE direct_messages (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  sender_id INT,
  receiver_id INT,
  content TEXT,
  message_type ENUM('text','image','file','ai') DEFAULT 'text',
  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  edited_at TIMESTAMP NULL,
  FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_dm_pair (sender_id, receiver_id, created_at DESC)
);

CREATE TABLE direct_message_reactions (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  direct_message_id BIGINT NOT NULL,
  user_id INT NOT NULL,
  emoji VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (direct_message_id) REFERENCES direct_messages(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_dm_reaction (direct_message_id, user_id, emoji),
  INDEX idx_dm_reactions (direct_message_id),
  INDEX idx_dm_user_reactions (user_id)
);

-- =====================================
-- 7Ô∏è‚É£ FRIENDS SYSTEM
-- =====================================

CREATE TABLE friend_requests (
  id INT AUTO_INCREMENT PRIMARY KEY,
  sender_id INT,
  receiver_id INT,
  status ENUM('pending','accepted','rejected','cancelled') DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (sender_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_request (sender_id, receiver_id)
);

CREATE TABLE friends (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  friend_id INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (friend_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_friendship (user_id, friend_id),
  INDEX idx_friends_user (user_id),
  INDEX idx_friends_friend (friend_id)
);

-- =====================================
-- 8Ô∏è‚É£ VOICE CHANNELS & SESSIONS
-- =====================================

CREATE TABLE voice_channels (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  channel_id INT,
  is_active BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE
);

CREATE TABLE voice_participants (
  id INT AUTO_INCREMENT PRIMARY KEY,
  voice_channel_id INT,
  user_id INT,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  left_at TIMESTAMP NULL,
  FOREIGN KEY (voice_channel_id) REFERENCES voice_channels(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE voice_sessions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT NOT NULL,
  user_id INT NOT NULL,
  is_muted BOOLEAN DEFAULT FALSE,
  is_deaf BOOLEAN DEFAULT FALSE,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_voice_session (channel_id, user_id),
  INDEX idx_channel_id (channel_id),
  INDEX idx_user_id (user_id),
  INDEX idx_joined_at (joined_at)
);

-- =====================================
-- 9Ô∏è‚É£ ATTACHMENTS (Files & Media)
-- =====================================

CREATE TABLE attachments (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  message_id BIGINT NULL,
  direct_message_id BIGINT NULL,
  file_name VARCHAR(255) NOT NULL,
  file_path VARCHAR(500) NOT NULL,
  file_size BIGINT,
  mime_type VARCHAR(100),
  uploaded_by INT,
  uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  FOREIGN KEY (direct_message_id) REFERENCES direct_messages(id) ON DELETE CASCADE,
  FOREIGN KEY (uploaded_by) REFERENCES users(id) ON DELETE CASCADE
);

-- =====================================
-- üîü AI AGENTS SYSTEM
-- =====================================

CREATE TABLE ai_agents (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100) UNIQUE NOT NULL,
  type ENUM('mood','summarizer','translator','moderator','assistant','engagement','knowledge','wellness','context','auto_message'),
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_agent_type (type)
);

CREATE TABLE ai_agent_logs (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  agent_id INT,
  user_id INT,
  channel_id INT NULL,
  message_id BIGINT NULL,
  action_type VARCHAR(100),
  input_text TEXT,
  output_text TEXT,
  confidence_score FLOAT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (agent_id) REFERENCES ai_agents(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE SET NULL,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE SET NULL
);

-- =====================================
-- 1Ô∏è‚É£1Ô∏è‚É£ MOOD & WELLNESS TRACKING
-- =====================================

CREATE TABLE user_mood_history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  mood ENUM('happy','sad','angry','neutral','excited','stressed') DEFAULT 'neutral',
  mood_score FLOAT,
  detected_by VARCHAR(50) DEFAULT 'mood_agent',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE user_moods (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  channel_id INT,
  mood VARCHAR(50) NOT NULL,
  sentiment_score FLOAT,
  detected_emotions JSON,
  message_sample TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE SET NULL,
  INDEX idx_user_mood (user_id, created_at),
  INDEX idx_channel_mood (channel_id, created_at)
);

CREATE TABLE mood_tracking (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  channel_id INT,
  message_id BIGINT,
  sentiment ENUM('positive', 'negative', 'neutral') NOT NULL,
  sentiment_score DECIMAL(3,2) DEFAULT 0.00,
  detected_language VARCHAR(20) DEFAULT 'en',
  original_text TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  INDEX idx_user_mood (user_id, created_at DESC),
  INDEX idx_channel_mood (channel_id, created_at DESC)
);

CREATE TABLE wellness_tracking (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  date DATE NOT NULL,
  activity_score DECIMAL(5,2) DEFAULT 0.00,
  stress_indicators INT DEFAULT 0,
  positive_interactions INT DEFAULT 0,
  negative_interactions INT DEFAULT 0,
  breaks_taken INT DEFAULT 0,
  total_messages INT DEFAULT 0,
  wellness_score DECIMAL(3,2) DEFAULT 0.00,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  UNIQUE KEY unique_user_date (user_id, date),
  INDEX idx_wellness_user (user_id, date DESC)
);

-- =====================================
-- 1Ô∏è‚É£2Ô∏è‚É£ KNOWLEDGE BASE & SUMMARIES
-- =====================================

CREATE TABLE conversation_summaries (
  id INT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT NOT NULL,
  summary TEXT,
  summary_text TEXT NOT NULL,
  message_count INT DEFAULT 0,
  participants TEXT,
  time_range_start TIMESTAMP NULL,
  time_range_end TIMESTAMP NULL,
  key_points TEXT,
  start_message_id BIGINT,
  end_message_id BIGINT,
  generated_by VARCHAR(50) DEFAULT 'summarizer_agent',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by INT,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  INDEX idx_channel_summaries (channel_id, created_at DESC)
);

CREATE TABLE knowledge_base (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(500) NOT NULL,
  content TEXT NOT NULL,
  source VARCHAR(50) DEFAULT 'agent',
  question TEXT,
  answer TEXT,
  source_message_id BIGINT,
  tags VARCHAR(500),
  relevance_score DECIMAL(3,2) DEFAULT 0.00,
  usage_count INT DEFAULT 0,
  related_channel INT NULL,
  community_id INT,
  created_by INT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (related_channel) REFERENCES channels(id) ON DELETE SET NULL,
  FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE SET NULL,
  FOREIGN KEY (source_message_id) REFERENCES messages(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  INDEX idx_kb_channel (related_channel),
  INDEX idx_kb_community (community_id),
  INDEX idx_channel (related_channel),
  INDEX idx_created (created_at),
  FULLTEXT INDEX idx_search (title, content),
  FULLTEXT INDEX ft_kb_question (question),
  FULLTEXT INDEX ft_kb_answer (answer)
);

-- =====================================
-- 1Ô∏è‚É£3Ô∏è‚É£ NOTIFICATIONS
-- =====================================

CREATE TABLE notifications (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  user_id INT,
  type ENUM('mention','reply','reaction','friend_request','system') NOT NULL,
  title VARCHAR(255),
  body TEXT,
  related_message_id BIGINT NULL,
  related_channel_id INT NULL,
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (related_message_id) REFERENCES messages(id) ON DELETE SET NULL,
  FOREIGN KEY (related_channel_id) REFERENCES channels(id) ON DELETE SET NULL
);

-- =====================================
-- 1Ô∏è‚É£4Ô∏è‚É£ MODERATION SYSTEM
-- =====================================

CREATE TABLE moderation_logs (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  channel_id INT,
  message_text TEXT NOT NULL,
  flag_type ENUM('clean', 'profanity', 'hate_speech', 'harassment', 'spam', 'personal_info', 'toxic') DEFAULT 'clean',
  severity ENUM('low', 'medium', 'high', 'critical') DEFAULT 'low',
  confidence FLOAT DEFAULT 0.0,
  action_taken ENUM('none', 'flagged', 'warned', 'deleted', 'banned') DEFAULT 'none',
  reason TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE SET NULL,
  INDEX idx_user_id (user_id),
  INDEX idx_channel_id (channel_id),
  INDEX idx_created_at (created_at),
  INDEX idx_flag_type (flag_type),
  INDEX idx_severity (severity)
);

CREATE TABLE moderation_log (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  message_id BIGINT NOT NULL,
  channel_id INT NOT NULL,
  user_id INT NOT NULL,
  flag_type ENUM('toxic', 'spam', 'inappropriate', 'other') NOT NULL,
  severity ENUM('low', 'medium', 'high', 'critical') DEFAULT 'medium',
  action_taken ENUM('flagged', 'warned', 'deleted', 'none') DEFAULT 'flagged',
  flagged_content TEXT,
  reason TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  INDEX idx_moderation_channel (channel_id, created_at DESC),
  INDEX idx_moderation_user (user_id, created_at DESC)
);

-- =====================================
-- 1Ô∏è‚É£5Ô∏è‚É£ ENGAGEMENT METRICS
-- =====================================

CREATE TABLE engagement_metrics (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  channel_id INT NOT NULL,
  date DATE NOT NULL,
  total_messages INT DEFAULT 0,
  active_users INT DEFAULT 0,
  avg_response_time DECIMAL(10,2) DEFAULT 0.00,
  engagement_score DECIMAL(5,2) DEFAULT 0.00,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (channel_id) REFERENCES channels(id) ON DELETE CASCADE,
  UNIQUE KEY unique_channel_date (channel_id, date),
  INDEX idx_engagement_channel (channel_id, date DESC)
);

-- 12. FINAL INDEXES
CREATE FULLTEXT INDEX ft_messages ON messages(content);
CREATE INDEX idx_friends_user ON friends(user_id);
CREATE INDEX idx_friends_friend ON friends(friend_id);
CREATE INDEX idx_messages_time ON messages(created_at DESC);